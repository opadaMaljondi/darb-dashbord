import{_ as se,D as te,r as p,aj as oe,o as ae,a as T,N as O,a7 as ie,Z as ne,ak as re,al as le,g as w,U as ce,i as r,y as V,w as c,W as G,n as e,k as l,J as _,t as z,l as d,M as J,C,L as Y,F as Q,q as W,z as Z,p as de}from"./vendor-8caf5d52.js";import{L as ue}from"./main-cc7bd0ce.js";import"./footer-502c2797.js";import"./app-974c65a1.js";const _e=""+new URL("avatar-2-52cb265f.jpg",import.meta.url).href,he={props:{conversations:Array,firebaseConfig:Object,selectedConversationId:Object},setup(b){te();const t=p(b.conversations),j=p([]),o=p({message:""}),h=p(b.selectedConversationId??null),R=p(""),B=p(_e),y=oe(),L=async a=>{try{const i=await T.get(`/chat/messages/${a}`);j.value=i.data;const n=t.value.find(m=>m.id===a);n.unread=0,S("users-chat")}catch(i){console.error("Error fetching messages:",i)}},S=a=>{setTimeout(()=>{const i=document.getElementById(a).querySelector("#chat-conversation .simplebar-content-wrapper"),n=document.getElementsByClassName("chat-conversation-list")[0].scrollHeight-window.innerHeight+600;n&&i.scrollTo({top:n,behavior:"smooth"})},300)},x=p(!1),E=p(!1),M=p(""),f=p([]),U=async()=>{const a=M.value.trim();if(a.length>2)try{const i=await T.get(`/chat/search-user?search=${a}`);f.value=i.data.data}catch(i){f.value=[],console.log("no users found"),console.error(i)}else f.value=[]},N=async()=>{E.value=!E.value,M.value.length>0&&(M.value=""),f.value.length>0&&(f.value=[])},s=async a=>{try{const n=(await T.post("/chat/createChat",{user_id:a.id})).data,m=new Date(n.created_at),g=D(m);if(n){let v={id:n.id,unread:0,subject:n.subject,role:a.role_name,profile_picture:n.profile_picture,last_message_time:g};t.value.unshift(v),await A(n.id)}N()}catch(i){f.value=[],console.log("no users found"),console.error(i)}};function D(a){const i={day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit",hour12:!0};return a.toLocaleString("en-GB",i).replace(",","")}const F=async a=>{if(a&&a.preventDefault(),y.value.$touch(),y.value.$invalid||x.value)return;x.value=!0;const i=o.value.message,n=new Date,m=(n.getHours()<10?"0":"")+n.getHours(),g=(n.getMinutes()<10?"0":"")+n.getMinutes(),v={align:"right",message:i,time:`${m}:${g}`,conversationId:h.value};try{await T.post("/chat/send-admin",v),o.value.message="",await L(h.value),S("users-chat")}catch(u){console.error("Error sending message:",u)}finally{x.value=!1}},A=async a=>{h.value=a;const i=t.value.find(n=>n.id===a);i&&(R.value=i.subject,B.value=i.profile_picture),await L(a),window.innerWidth<992&&document.querySelector(".user-chat").classList.add("user-chat-show")},K=()=>{const a=document.querySelector(".user-chat");a&&a.classList.remove("user-chat-show")},P=()=>{const a=G.mixin({customClass:{confirmButton:"btn btn-success me-2",cancelButton:"btn btn-danger ml-2"},buttonsStyling:!1});a.fire({title:"Are you sure?",text:"You need to close this chat!",icon:"warning",confirmButtonText:"Yes, close it!",cancelButtonText:"No, cancel!",showCancelButton:!0}).then(async i=>{if(i.isConfirmed)try{await T.post("/chat/close-chat",{conversationId:h.value}),t.value=t.value.filter(n=>n.id!==h.value),a.fire("Closed!","Your chat has been closed.","success"),h.value=null,j.value=[]}catch(n){console.error(n),a.fire("Error!","There was a problem closing the chat.","error")}else i.dismiss===G.DismissReason.cancel&&a.fire("Cancelled","Your chat conversation is safe :)","error")})},X=a=>{if(a){const i=new Date(a),n=i.getHours().toString().padStart(2,"0"),m=i.getMinutes().toString().padStart(2,"0");return`${n}:${m}`}return""},$=async a=>{try{return(await T.get(`/chat/fetch-user?user_id=${a}`)).data}catch(i){console.error(i)}};return ae(async()=>{try{h.value&&await A(h.value);const i=b.firebaseConfig;firebase.apps.length||firebase.initializeApp(i);const n=firebase.database().ref("conversation");let m=!1;t.value.forEach(g=>{g.last_message_time=D(new Date(g.last_message_time))}),t.value.forEach(g=>{n.child(g.id).on("value",async function(v){const u=v.val();if(m&&u&&u.sender_type!=="admin")if(u.conversation_id==h.value){const k=new Date(u.created_at),I=D(k);let q={id:u.message_id,align:"left",message:u.message,profile_picture:B.value,time:I};j.value.push(q),S("users-chat")}else{let k=t.value.find(I=>I.id===u.conversation_id);k?(k.unread=parseInt(k.unread)+1,k.last_message_time=D(new Date(u.created_at))):console.error("Conversation not found!")}})}),setTimeout(function(){m=!0},2e3),n.on("child_added",async function(g){if(m){const v=g.val(),u=await $(v.sender_id),k=new Date(v.created_at),I=D(k);if(v.conversation_id==h.value){let q={id:v.message_id,align:"left",role:u.name,message:u.name,profile_picture:u.profile_picture,time:I};j.value.push(q),S("users-chat")}else try{const H=(await T.get(`/chat/verify-chat?conversationId=${v.conversation_id}`)).data.data;if(H){let ee={id:H.id,unread:1,subject:H.subject,role:u.role_name,profile_picture:H.profile_picture,last_message_time:I};t.value.unshift(ee)}}catch(q){console.log("no conversation found"),console.error(q)}}})}catch(i){console.error(i)}let a=Date.now();document.addEventListener("visibilitychange",()=>{document.hidden?a=Date.now():Date.now()-a>=3e5&&O.page.url=="/chat"&&(console.log("cnkasn"),O.get("/chat"))})}),{v$:y,form:o,conversationsData:t,messagesData:j,formSubmit:F,isSubmitting:x,selectedConversationId:h,scrollToBottom:S,convertedTime:X,selectConversation:A,username:R,profile:B,cancel:P,userSearch:E,toggleSearch:N,searchQuery:M,users:f,onSearch:U,createChat:s,closeChat:K}},components:{Layout:ue,simplebar:ie,Head:ne},validations:{form:{message:{required:re.withMessage("Message is required",le)}}}},me={class:"chat-wrapper d-lg-flex gap-1 mx-n4 mt-n4 p-1"},ve={class:"chat-leftsidebar"},fe={class:"px-4 pt-4 mb-4"},ge={class:"d-flex align-items-center gap-4"},pe={key:0,class:"flex-grow-1"},be={class:"mb-0"},xe={key:1,class:"flex-grow-1"},we={class:"mb-0"},ye={key:2,class:"flex-shrink-0"},ke={title:"Add Contact"},Ce={key:3,class:"flex-shrink-0"},Be={title:"Cancel"},Se={key:4,class:"dropdown-menu-xl"},De={class:"search-box position-relative"},Te={class:"d-flex align-items-center px-4 mb-2"},je={class:"flex-grow-1"},Le={class:"mb-0 fs-11 text-muted text-uppercase"},Me={class:"chat-message-list"},Ie={class:"list-unstyled chat-list chat-user-list"},qe=["onClick"],Ee={class:"d-flex align-items-center"},Ne={class:"flex-shrink-0 chat-user-img online align-self-center me-2 ms-0"},He={key:0,class:"avatar-xxs avatar-xs"},Ve=["src"],ze={key:1,class:"avatar-xxs avatar-xs"},Re={class:"avatar-title rounded-circle bg-danger userprofile avatar-xs"},Ue={class:"flex-grow-1 overflow-hidden"},Ae={class:"text-truncate mb-1"},Ye={class:"text-muted mb-1"},Qe={class:"d-flex align-items-center px-4 mb-2"},We={class:"flex-grow-1"},Fe={class:"mb-0 fs-11 text-muted text-uppercase"},Oe={class:"chat-message-list"},Ge={class:"list-unstyled chat-list chat-user-list"},Je=["onClick"],Ze={class:"d-flex align-items-center"},Ke={class:"flex-shrink-0 chat-user-img online align-self-center me-2 ms-0"},Pe={key:0,class:"avatar-xxs avatar-xs"},Xe=["src"],$e={key:1,class:"avatar-xxs avatar-xs"},es={class:"avatar-title rounded-circle bg-danger userprofile avatar-xs"},ss={class:"flex-grow-1 overflow-hidden"},ts={class:"text-truncate mb-1"},os={class:"text-muted mb-1"},as={class:"d-flex align-items-center"},is={key:0,class:"position-absolute translate-middle badge border border-light rounded-circle bg-success p-1"},ns={class:"flex-shrink-0"},rs={class:"user-chat w-100 overflow-hidden"},ls={class:"chat-content d-lg-flex"},cs={class:"w-100 overflow-hidden position-relative"},ds={key:0,class:"position-relative"},us={class:"p-3 user-chat-topbar"},_s={class:"d-flex align-items-center"},hs={class:"flex-shrink-0 d-block d-lg-none me-3"},ms={class:"flex-grow-1 overflow-hidden"},vs={class:"d-flex align-items-center"},fs={class:"flex-shrink-0 chat-user-img online user-own-img align-self-center me-3 ms-0"},gs=["src"],ps={class:"flex-grow-1 overflow-hidden"},bs={class:"text-truncate mb-0 fs-16"},xs={class:"list-inline user-chat-nav text-end mb-0"},ws={class:"list-inline-item m-0"},ys={class:"position-relative",id:"users-chat"},ks={class:"list-unstyled chat-conversation-list"},Cs={class:"conversation-list d-flex align-items-center"},Bs={key:0,class:"chat-avatar"},Ss=["src"],Ds={class:"user-chat-content"},Ts={class:"ctext-wrap"},js={class:"ctext-wrap-content"},Ls={class:"mb-0 ctext-content"},Ms={class:"conversation-name"},Is={class:"text-muted time"},qs={class:"chat-input-section p-3 p-lg-4"},Es=["disabled","placeholder"],Ns={class:"chat-input-links ms-2"},Hs={class:"links-list-item"},Vs={key:0,class:"ri-send-plane-2-fill align-bottom"},zs={key:1,class:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"},Rs={key:1,class:"position-relative"};function Us(b,t,j,o,h,R){const B=w("BButton"),y=w("BLink"),L=w("simplebar"),S=w("BBadge"),x=w("BCol"),E=w("BDropdownItem"),M=w("BDropdown"),f=w("BRow"),U=w("Layout"),N=ce("b-tooltip");return r(),V(U,null,{default:c(()=>[e("div",me,[e("div",ve,[e("div",fe,[e("div",ge,[o.userSearch?(r(),l("div",xe,[e("h5",we,_(b.$t("users")),1)])):(r(),l("div",pe,[e("h5",be,_(b.$t("chats")),1)])),o.userSearch?(r(),l("div",Ce,[z((r(),l("div",Be,[d(B,{type:"button",onClick:o.toggleSearch,variant:"soft-success",size:"sm"},{default:c(()=>t[6]||(t[6]=[e("i",{class:"ri-close-line align-bottom"},null,-1)])),_:1,__:[6]},8,["onClick"])])),[[N,void 0,void 0,{hover:!0}]])])):(r(),l("div",ye,[z((r(),l("div",ke,[d(B,{type:"button",onClick:o.toggleSearch,variant:"soft-success",size:"sm"},{default:c(()=>t[5]||(t[5]=[e("i",{class:"ri-add-line align-bottom"},null,-1)])),_:1,__:[5]},8,["onClick"])])),[[N,void 0,void 0,{hover:!0}]])])),o.userSearch?(r(),l("div",Se,[e("div",De,[z(e("input",{type:"text",class:"form-control bg-light border-light",placeholder:"Search users...",id:"searchMessage","onUpdate:modelValue":t[0]||(t[0]=s=>o.searchQuery=s),onInput:t[1]||(t[1]=(...s)=>o.onSearch&&o.onSearch(...s))},null,544),[[J,o.searchQuery]]),t[7]||(t[7]=e("i",{class:"ri-search-2-line search-icon"},null,-1))])])):C("",!0)])]),o.userSearch?(r(),V(L,{key:0,class:"chat-room-list","data-simplebar":""},{default:c(()=>[e("div",Te,[e("div",je,[e("h4",Le,_(b.$t("users")),1)])]),e("div",Me,[e("div",Ie,[(r(!0),l(Q,null,Y(o.users,(s,D)=>(r(),l("li",{class:"",key:s.id,onClick:F=>o.createChat(s)},[d(y,{href:"javascript: void(0);"},{default:c(()=>[e("div",Ee,[e("div",Ne,[s.profile_picture?(r(),l("div",He,[e("img",{src:`${s.profile_picture}`,class:"rounded-circle img-fluid userprofile avatar-xs",alt:""},null,8,Ve)])):C("",!0),s.profile_picture?C("",!0):(r(),l("div",ze,[e("div",Re,_(s.profile_picture),1)]))]),e("div",Ue,[e("p",Ae,_(s.name),1),e("p",Ye,_(s.role_name),1)])])]),_:2},1024)],8,qe))),128))])])]),_:1})):(r(),V(L,{key:1,class:"chat-room-list","data-simplebar":""},{default:c(()=>[e("div",Qe,[e("div",We,[e("h4",Fe,_(b.$t("direct_messages")),1)])]),e("div",Oe,[e("div",Ge,[(r(!0),l(Q,null,Y(o.conversationsData,s=>(r(),l("li",{class:W(["",{active:o.selectedConversationId===s.id}]),key:s.id,onClick:D=>o.selectConversation(s.id)},[d(y,{href:"javascript: void(0);"},{default:c(()=>[e("div",Ze,[e("div",Ke,[s.profile_picture?(r(),l("div",Pe,[e("img",{src:`${s.profile_picture}`,class:"rounded-circle img-fluid userprofile avatar-xs",alt:""},null,8,Xe)])):C("",!0),s.profile_picture?C("",!0):(r(),l("div",$e,[e("div",es,_(s.profile_picture),1)]))]),e("div",ss,[e("p",ts,_(s.subject),1),e("p",os,_(s.role),1)]),e("div",as,[s.unread>0?(r(),l("span",is,_(s.unread),1)):C("",!0)]),e("div",ns,[s.unread>0?(r(),V(S,{key:0,variant:"dark-subtle",class:"bg-dark-subtle text-body rounded p-1"},{default:c(()=>[Z(_(s.last_seen??o.convertedTime(s.last_message_time)),1)]),_:2},1024)):C("",!0)])])]),_:2},1024)],10,Je))),128))])])]),_:1}))]),e("div",rs,[e("div",ls,[e("div",cs,[o.selectedConversationId?(r(),l("div",ds,[e("div",us,[d(f,{class:"align-items-center"},{default:c(()=>[d(x,{sm:"4",cols:"8"},{default:c(()=>[e("div",_s,[e("div",hs,[d(y,{href:"javascript: void(0);",onClick:o.closeChat,class:"user-chat-remove fs-18 p-1"},{default:c(()=>t[8]||(t[8]=[e("i",{class:"ri-arrow-left-s-line align-bottom"},null,-1)])),_:1,__:[8]},8,["onClick"])]),e("div",ms,[e("div",vs,[e("div",fs,[e("img",{src:o.profile?o.profile:require("@/assets/images/users/user-dummy-img.jpg"),class:"rounded-circle avatar-xs",alt:""},null,8,gs),t[9]||(t[9]=e("span",{class:"user-status"},null,-1))]),e("div",ps,[e("h5",bs,[d(y,{class:"text-reset username"},{default:c(()=>[Z(_(o.username),1)]),_:1})])])])])])]),_:1}),d(x,{sm:"8",cols:"4"},{default:c(()=>[e("ul",xs,[e("li",ws,[d(M,{variant:"link",class:"btn btn-ghost-secondary btn-icon","toggle-class":" arrow-none","menu-class":"dropdown-menu","aria-haspopup":"true"},{"button-content":c(()=>t[10]||(t[10]=[e("i",{class:"ri-settings-2-fill"},null,-1)])),default:c(()=>[d(E,null,{default:c(()=>[t[11]||(t[11]=e("i",{class:"ri-mail-close-fill align-bottom text-danger me-2"},null,-1)),e("span",{class:"text-danger",id:"sa-params",onClick:t[2]||(t[2]=(...s)=>o.cancel&&o.cancel(...s))},"Close Chat")]),_:1,__:[11]})]),_:1})])])]),_:1})]),_:1})]),e("div",ys,[d(L,{class:"chat-conversation p-3 p-lg-4",id:"chat-conversation","data-simplebar":"",ref:"current"},{default:c(()=>[e("ul",ks,[(r(!0),l(Q,null,Y(o.messagesData,s=>(r(),l("li",{key:s.id,class:W(["chat-list",s.align])},[e("div",Cs,[s.align!=="right"?(r(),l("div",Bs,[e("img",{src:s.profile_picture,alt:""},null,8,Ss)])):C("",!0),e("div",Ds,[e("div",Ts,[e("div",js,[e("p",Ls,_(s.message),1)])]),e("div",Ms,[e("small",Is,_(s.time),1),t[12]||(t[12]=e("span",{class:"text-success"},[e("i",{class:"bx bx-check"})],-1))])])])],2))),128))])]),_:1},512)]),e("div",qs,[e("form",{onSubmit:t[4]||(t[4]=de((...s)=>o.formSubmit&&o.formSubmit(...s),["prevent"]))},[d(f,{class:"g-0 align-items-center"},{default:c(()=>[d(x,null,{default:c(()=>[z(e("input",{disabled:o.isSubmitting,"onUpdate:modelValue":t[3]||(t[3]=s=>o.form.message=s),class:W([{"is-invalid":o.v$.form.message.$invalid},"form-control chat-input bg-light border-light"]),type:"text",placeholder:b.$t("enter_message")},null,10,Es),[[J,o.form.message]])]),_:1}),d(x,{cols:"auto"},{default:c(()=>[e("div",Ns,[e("div",Hs,[d(B,{disabled:o.isSubmitting,variant:"success",type:"submit",class:"chat-send"},{default:c(()=>[o.isSubmitting?(r(),l("span",zs)):(r(),l("i",Vs))]),_:1},8,["disabled"])])])]),_:1})]),_:1})],32)])])):(r(),l("div",Rs))])])])])]),_:1})}const Fs=se(he,[["render",Us]]);export{Fs as default};
